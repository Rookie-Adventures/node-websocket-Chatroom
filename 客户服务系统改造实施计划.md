# å®¢æˆ·æœåŠ¡ç³»ç»Ÿæ”¹é€ å®æ–½è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å°†ç°æœ‰çš„WebSocketèŠå¤©å®¤æ”¹é€ ä¸ºä¸“ä¸šçš„å®¢æˆ·æœåŠ¡ç³»ç»Ÿï¼Œå®ç°ä¸¥æ ¼çš„æƒé™æ§åˆ¶å’Œç”¨æˆ·ç®¡ç†ã€‚

### æ ¸å¿ƒéœ€æ±‚
1. **å•å‘æ²Ÿé€šæ¨¡å¼**ï¼šåªå…è®¸ç”¨æˆ·ä¸ç®¡ç†å‘˜èŠå¤©ï¼Œç¦æ­¢ç”¨æˆ·é—´ç§èŠ
2. **ç®¡ç†å‘˜ä¸“å±å‘è¨€æƒ**ï¼šèŠå¤©å®¤æ”¹åé€šçŸ¥é¢‘é“ä¸­åªæœ‰ç®¡ç†å‘˜å¯ä»¥å‘è¨€
3. **è®¾å¤‡å”¯ä¸€æ€§ç»‘å®š**ï¼šä¸€å°è®¾å¤‡åªèƒ½ç»‘å®šä¸€ä¸ªç”¨æˆ·è´¦å·ï¼ˆè®¾å¤‡æŒ‡çº¹ï¼ŒIPï¼ŒUser-Agentï¼Œæµè§ˆå™¨ç±»å‹ï¼Œæ“ä½œç³»ç»Ÿï¼Œåˆ†è¾¨ç‡ï¼‰ä½¿ç”¨ä¸“é—¨çš„è®¾å¤‡æŒ‡çº¹åº“
4. **æŒä¹…åŒ–ç™»å½•**ï¼šç”¨æˆ·ç™»å½•çŠ¶æ€éœ€è¦é•¿æœŸä¿å­˜
5. **ç”¨æˆ·åå”¯ä¸€æ€§**ï¼šç¡®ä¿ç”¨æˆ·åä¸é‡å¤
6. **ç”¨æˆ·å¯†ç éªŒè¯**ï¼šç™»å½•æ—¶éœ€è¦éªŒè¯ç”¨æˆ·åå’Œå¯†ç ï¼ˆç™»å½•å³æ³¨å†Œï¼‰


---

## ğŸ› ï¸ æŠ€æœ¯å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šç”¨æˆ·æƒé™ç³»ç»Ÿé‡æ„ (2-3å¤©)

#### 1.1 æ•°æ®åº“ç»“æ„å‡çº§
**ç›®æ ‡**ï¼šæ·»åŠ ç”¨æˆ·è§’è‰²å’Œæƒé™å­—æ®µ

**å®æ–½å†…å®¹**ï¼š
- ä¿®æ”¹ç”¨æˆ·æ•°æ®ç»“æ„ï¼Œæ·»åŠ  `role` å­—æ®µï¼ˆadmin/customerï¼‰
- æ·»åŠ  `deviceFingerprint` å­—æ®µç”¨äºè®¾å¤‡ç»‘å®š
- æ·»åŠ  `lastLogin` å’Œ `createdAt` æ—¶é—´æˆ³
- åˆ›å»ºè®¾å¤‡ç»‘å®šè¡¨

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `server/store.js` - æ•°æ®å­˜å‚¨é€»è¾‘
- `server/db.js` - æ•°æ®åº“æ“ä½œ

#### 1.2 è§’è‰²æƒé™ä¸­é—´ä»¶
**ç›®æ ‡**ï¼šå®ç°åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

**å®æ–½å†…å®¹**ï¼š
- åˆ›å»ºæƒé™éªŒè¯ä¸­é—´ä»¶
- å®ç°è§’è‰²æ£€æŸ¥å‡½æ•°
- æ·»åŠ æƒé™è£…é¥°å™¨

**æ–°å¢æ–‡ä»¶**ï¼š
- `server/middleware/auth.js` - æƒé™éªŒè¯ä¸­é—´ä»¶
- `server/middleware/role.js` - è§’è‰²æ£€æŸ¥

#### 1.3 æ¶ˆæ¯æƒé™æ§åˆ¶
**ç›®æ ‡**ï¼šé™åˆ¶æ¶ˆæ¯å‘é€æƒé™

**å®æ–½å†…å®¹**ï¼š
- ä¿®æ”¹æ¶ˆæ¯å‘é€é€»è¾‘ï¼Œåªå…è®¸ç®¡ç†å‘˜åœ¨ç¾¤èŠä¸­å‘è¨€
- å®¢æˆ·åªèƒ½ä¸ç®¡ç†å‘˜è¿›è¡Œç§èŠ
- ç¦ç”¨å®¢æˆ·é—´çš„ç§èŠåŠŸèƒ½

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `server/io.js` - Socket.ioäº‹ä»¶å¤„ç†

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// æ¶ˆæ¯å‘é€æƒé™æ§åˆ¶
socket.on('message', (from, to, message, type) => {
  // æ£€æŸ¥ç”¨æˆ·è§’è‰²
  if (from.role === 'customer' && to.type === 'group') {
    return socket.emit('error', 'å®¢æˆ·æ— æ³•åœ¨ç¾¤èŠä¸­å‘è¨€');
  }
  
  // æ£€æŸ¥ç§èŠæƒé™
  if (from.role === 'customer' && to.type === 'user' && to.role !== 'admin') {
    return socket.emit('error', 'å®¢æˆ·åªèƒ½ä¸ç®¡ç†å‘˜ç§èŠ');
  }
  
  // ç»§ç»­åŸæœ‰é€»è¾‘...
});
```

---

### ç¬¬äºŒé˜¶æ®µï¼šè®¾å¤‡ç»‘å®šç³»ç»Ÿ (3-4å¤©)

#### 2.1 è®¾å¤‡æŒ‡çº¹è¯†åˆ«
**ç›®æ ‡**ï¼šç”Ÿæˆå”¯ä¸€è®¾å¤‡æ ‡è¯†

**å®æ–½å†…å®¹**ï¼š
- æ”¶é›†è®¾å¤‡ä¿¡æ¯ï¼šIPåœ°å€ã€User-Agentã€å±å¹•åˆ†è¾¨ç‡ç­‰
- ç”Ÿæˆè®¾å¤‡æŒ‡çº¹ç®—æ³•
- å®ç°è®¾å¤‡ä¿¡æ¯å­˜å‚¨

**æ–°å¢æ–‡ä»¶**ï¼š
- `server/utils/deviceFingerprint.js` - è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
function generateDeviceFingerprint(handshake) {
  const ip = handshake.address.replace(/::ffff:/, '');
  const userAgent = handshake.headers['user-agent'];
  const acceptLanguage = handshake.headers['accept-language'];
  
  return crypto.createHash('sha256')
    .update(`${ip}-${userAgent}-${acceptLanguage}`)
    .digest('hex');
}
```

#### 2.2 è®¾å¤‡ç»‘å®šéªŒè¯
**ç›®æ ‡**ï¼šç¡®ä¿ä¸€è®¾å¤‡ä¸€ç”¨æˆ·

**å®æ–½å†…å®¹**ï¼š
- ç™»å½•æ—¶æ£€æŸ¥è®¾å¤‡ç»‘å®šçŠ¶æ€
- å®ç°è®¾å¤‡ç»‘å®š/è§£ç»‘åŠŸèƒ½
- æ·»åŠ å¼‚å¸¸ç™»å½•æ£€æµ‹

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `server/io.js` - ç™»å½•éªŒè¯é€»è¾‘
- `server/store.js` - è®¾å¤‡ç»‘å®šæ•°æ®æ“ä½œ

#### 2.3 ç®¡ç†å‘˜è®¾å¤‡ç®¡ç†
**ç›®æ ‡**ï¼šç®¡ç†å‘˜å¯ä»¥ç®¡ç†è®¾å¤‡ç»‘å®š

**å®æ–½å†…å®¹**ï¼š
- æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡ç»‘å®šå…³ç³»
- å¼ºåˆ¶è§£ç»‘è®¾å¤‡åŠŸèƒ½
- è®¾å¤‡ç»‘å®šå†å²è®°å½•

---

### ç¬¬ä¸‰é˜¶æ®µï¼šæŒä¹…åŒ–å­˜å‚¨ä¼˜åŒ– (2-3å¤©)

#### 3.1 æ•°æ®åº“å‡çº§
**ç›®æ ‡**ï¼šæå‡æ•°æ®å­˜å‚¨ç¨³å®šæ€§

**å®æ–½å†…å®¹**ï¼š
- è¯„ä¼°æ˜¯å¦éœ€è¦ä»NeDBè¿ç§»åˆ°SQLite/MongoDB
- è®¾è®¡æ–°çš„æ•°æ®è¡¨ç»“æ„
- å®ç°æ•°æ®è¿ç§»è„šæœ¬

**æ•°æ®è¡¨è®¾è®¡**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id VARCHAR(50) PRIMARY KEY,
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255),
  role ENUM('admin', 'customer') DEFAULT 'customer',
  device_fingerprint VARCHAR(255),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_login TIMESTAMP,
  is_active BOOLEAN DEFAULT true
);

-- è®¾å¤‡ç»‘å®šè¡¨
CREATE TABLE device_bindings (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id VARCHAR(50),
  device_fingerprint VARCHAR(255),
  ip_address VARCHAR(45),
  user_agent TEXT,
  bound_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  is_active BOOLEAN DEFAULT true,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- æ¶ˆæ¯è¡¨
CREATE TABLE messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  from_user_id VARCHAR(50),
  to_user_id VARCHAR(50),
  to_type ENUM('user', 'group'),
  message_type ENUM('text', 'image', 'emoji'),
  content TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (from_user_id) REFERENCES users(id),
  FOREIGN KEY (to_user_id) REFERENCES users(id)
);
```

#### 3.2 é•¿æœŸTokenæœºåˆ¶
**ç›®æ ‡**ï¼šå®ç°æŒä¹…åŒ–ç™»å½•

**å®æ–½å†…å®¹**ï¼š
- å®ç°Refresh Tokenæœºåˆ¶
- è‡ªåŠ¨ç™»å½•åŠŸèƒ½
- Tokenå®‰å…¨æ€§å¢å¼º

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `server/jwt.js` - JWT Tokenç®¡ç†

---

### ç¬¬å››é˜¶æ®µï¼šç•Œé¢ä¼˜åŒ–æ”¹é€  (4-5å¤©)

#### 4.1 ç®¡ç†å‘˜ç•Œé¢å¼€å‘
**ç›®æ ‡**ï¼šæä¾›å®Œæ•´çš„ç®¡ç†åŠŸèƒ½

**å®æ–½å†…å®¹**ï¼š
- ç”¨æˆ·ç®¡ç†ç•Œé¢ï¼šæŸ¥çœ‹ã€ç¦ç”¨ã€åˆ é™¤ç”¨æˆ·
- è®¾å¤‡ç®¡ç†ç•Œé¢ï¼šæŸ¥çœ‹ç»‘å®šå…³ç³»ã€å¼ºåˆ¶è§£ç»‘
- æ¶ˆæ¯ç›‘æ§ç•Œé¢ï¼šæŸ¥çœ‹æ‰€æœ‰å¯¹è¯è®°å½•
- ç³»ç»Ÿè®¾ç½®ç•Œé¢ï¼šè§’è‰²æƒé™é…ç½®

**æ–°å¢ç»„ä»¶**ï¼š
- `src/components/AdminPanel.vue` - ç®¡ç†å‘˜ä¸»é¢æ¿
- `src/components/UserManagement.vue` - ç”¨æˆ·ç®¡ç†
- `src/components/DeviceManagement.vue` - è®¾å¤‡ç®¡ç†
- `src/components/MessageMonitor.vue` - æ¶ˆæ¯ç›‘æ§

#### 4.2 å®¢æˆ·ç•Œé¢ç®€åŒ–
**ç›®æ ‡**ï¼šç®€åŒ–å®¢æˆ·ç«¯ç•Œé¢ï¼Œåªä¿ç•™å¿…è¦åŠŸèƒ½

**å®æ–½å†…å®¹**ï¼š
- ç§»é™¤ç¾¤èŠå…¥å£å’Œç”¨æˆ·åˆ—è¡¨
- åªæ˜¾ç¤ºä¸ç®¡ç†å‘˜çš„å¯¹è¯
- ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ
- æ·»åŠ å®¢æœçŠ¶æ€æ˜¾ç¤º

**æ–‡ä»¶ä¿®æ”¹**ï¼š
- `src/components/ChatApp.vue` - ä¸»èŠå¤©ç•Œé¢
- `src/components/UserLogin.vue` - ç™»å½•ç•Œé¢

#### 4.3 å®æ—¶çŠ¶æ€æ˜¾ç¤º
**ç›®æ ‡**ï¼šæ˜¾ç¤ºç³»ç»Ÿå’Œç”¨æˆ·çŠ¶æ€

**å®æ–½å†…å®¹**ï¼š
- ç®¡ç†å‘˜åœ¨çº¿çŠ¶æ€
- æ’é˜Ÿç­‰å¾…æç¤º
- æ¶ˆæ¯é€è¾¾çŠ¶æ€
- ç³»ç»Ÿé€šçŸ¥åŠŸèƒ½

---

## ğŸ”§ å…³é”®æŠ€æœ¯å®ç°

### æƒé™æ§åˆ¶ç³»ç»Ÿ

```javascript
// server/middleware/auth.js
class AuthMiddleware {
  static checkRole(requiredRole) {
    return (socket, next) => {
      if (!socket.user || socket.user.role !== requiredRole) {
        return next(new Error('æƒé™ä¸è¶³'));
      }
      next();
    };
  }
  
  static checkDeviceBinding(socket, next) {
    const deviceFingerprint = generateDeviceFingerprint(socket.handshake);
    const existingUser = store.getUserByDevice(deviceFingerprint);
    
    if (existingUser && existingUser.id !== socket.user.id) {
      return next(new Error('è¯¥è®¾å¤‡å·²ç»‘å®šå…¶ä»–ç”¨æˆ·'));
    }
    
    next();
  }
}
```

### æ¶ˆæ¯è·¯ç”±æ§åˆ¶

```javascript
// server/io.js æ¶ˆæ¯å¤„ç†é€»è¾‘
function handleMessage(socket, from, to, message, type) {
  // æƒé™æ£€æŸ¥
  if (!checkMessagePermission(from, to)) {
    return socket.emit('error', 'æ— æƒé™å‘é€æ­¤æ¶ˆæ¯');
  }
  
  // æ¶ˆæ¯è·¯ç”±
  if (to.type === 'group' && from.role === 'admin') {
    // ç®¡ç†å‘˜ç¾¤å‘æ¶ˆæ¯
    socket.broadcast.emit('message', from, to, message, type);
  } else if (to.type === 'user') {
    // ç§èŠæ¶ˆæ¯
    socket.broadcast.to(to.roomId).emit('message', from, to, message, type);
  }
  
  // ä¿å­˜æ¶ˆæ¯
  store.saveMessage(from, to, message, type);
}

function checkMessagePermission(from, to) {
  // å®¢æˆ·ä¸èƒ½åœ¨ç¾¤èŠä¸­å‘è¨€
  if (from.role === 'customer' && to.type === 'group') {
    return false;
  }
  
  // å®¢æˆ·åªèƒ½ä¸ç®¡ç†å‘˜ç§èŠ
  if (from.role === 'customer' && to.type === 'user' && to.role !== 'admin') {
    return false;
  }
  
  return true;
}
```

---

## ğŸ“… å¼€å‘æ—¶é—´è§„åˆ’

| é˜¶æ®µ | å†…å®¹ | é¢„è®¡æ—¶é—´ | è´Ÿè´£äºº |
|------|------|----------|--------|
| ç¬¬ä¸€é˜¶æ®µ | æƒé™ç³»ç»Ÿé‡æ„ | 2-3å¤© | åç«¯å¼€å‘ |
| ç¬¬äºŒé˜¶æ®µ | è®¾å¤‡ç»‘å®šç³»ç»Ÿ | 3-4å¤© | åç«¯å¼€å‘ |
| ç¬¬ä¸‰é˜¶æ®µ | æ•°æ®åº“ä¼˜åŒ– | 2-3å¤© | åç«¯å¼€å‘ |
| ç¬¬å››é˜¶æ®µ | ç•Œé¢æ”¹é€  | 4-5å¤© | å‰ç«¯å¼€å‘ |
| æµ‹è¯•ä¼˜åŒ– | åŠŸèƒ½æµ‹è¯•å’Œä¼˜åŒ– | 2-3å¤© | å…¨æ ˆæµ‹è¯• |

**æ€»è®¡ï¼š13-18å¤©**

---

## ğŸš€ éƒ¨ç½²å’Œæµ‹è¯•è®¡åˆ’

### æµ‹è¯•ç¯å¢ƒæ­å»º
1. å‡†å¤‡å¤šå°è®¾å¤‡è¿›è¡Œè®¾å¤‡ç»‘å®šæµ‹è¯•
2. åˆ›å»ºç®¡ç†å‘˜å’Œå®¢æˆ·æµ‹è¯•è´¦å·
3. æ¨¡æ‹Ÿå„ç§æƒé™åœºæ™¯

### åŠŸèƒ½æµ‹è¯•æ¸…å•
- [ ] ç”¨æˆ·æ³¨å†Œå’Œç™»å½•
- [ ] è®¾å¤‡ç»‘å®šéªŒè¯
- [ ] è§’è‰²æƒé™æ§åˆ¶
- [ ] æ¶ˆæ¯å‘é€æƒé™
- [ ] ç®¡ç†å‘˜åŠŸèƒ½
- [ ] æŒä¹…åŒ–ç™»å½•
- [ ] å¼‚å¸¸æƒ…å†µå¤„ç†

### æ€§èƒ½æµ‹è¯•
- å¹¶å‘ç”¨æˆ·è¿æ¥æµ‹è¯•
- æ¶ˆæ¯ä¼ è¾“æ€§èƒ½æµ‹è¯•
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å¤‡ä»½**ï¼šåœ¨è¿›è¡Œæ•°æ®åº“ç»“æ„ä¿®æ”¹å‰ï¼ŒåŠ¡å¿…å¤‡ä»½ç°æœ‰æ•°æ®
2. **æ¸è¿›å¼éƒ¨ç½²**ï¼šå»ºè®®åˆ†é˜¶æ®µéƒ¨ç½²ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µåŠŸèƒ½ç¨³å®š
3. **ç”¨æˆ·é€šçŸ¥**ï¼šæå‰é€šçŸ¥ç°æœ‰ç”¨æˆ·ç³»ç»Ÿå‡çº§å’ŒåŠŸèƒ½å˜æ›´
4. **å›æ»šè®¡åˆ’**ï¼šå‡†å¤‡å›æ»šæ–¹æ¡ˆï¼Œä»¥é˜²å‡çº§è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜
5. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°ç”¨æˆ·æ‰‹å†Œå’ŒæŠ€æœ¯æ–‡æ¡£

---

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

1. **AIå®¢æœé›†æˆ**ï¼šé›†æˆæ™ºèƒ½å®¢æœæœºå™¨äºº
2. **å¤šåª’ä½“æ”¯æŒ**ï¼šæ”¯æŒæ–‡ä»¶ä¼ è¾“ã€è¯­éŸ³æ¶ˆæ¯
3. **æ•°æ®åˆ†æ**ï¼šå®¢æœæ•ˆç‡åˆ†æã€ç”¨æˆ·æ»¡æ„åº¦ç»Ÿè®¡
4. **ç§»åŠ¨ç«¯APP**ï¼šå¼€å‘ä¸“ç”¨çš„ç§»åŠ¨ç«¯åº”ç”¨
5. **APIå¼€æ”¾**ï¼šæä¾›ç¬¬ä¸‰æ–¹é›†æˆAPI

---

*æ–‡æ¡£åˆ›å»ºæ—¶é—´ï¼š2024å¹´12æœˆ*
*æœ€åæ›´æ–°ï¼š2024å¹´12æœˆ*